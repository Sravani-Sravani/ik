<%@page import="com.liferay.portal.kernel.dao.orm.RestrictionsFactoryUtil"%>
<%@page import="com.liferay.portal.kernel.dao.orm.DynamicQuery"%>
<%@page import="com.liferay.portal.kernel.util.ParamUtil"%>
<%@page import="com.liferay.portal.kernel.util.ListUtil"%>
<%@page import="javax.portlet.PortletURL"%>
<%@page import ="com.liferay.portal.kernel.dao.orm.OrderFactoryUtil"%>
<%@page import="com.kpmg.citizenTables.model.Ministry"%>
<%@page import="com.kpmg.citizenTables.service.MinistryLocalServiceUtil"%>
<%@page import="com.kpmg.citizenTables.service.InfraKnowledgeSubCategoryLocalServiceUtil"%>
<%@page import="com.kpmg.citizenTables.service.InfraKnowledgeCategoryLocalServiceUtil"%>
<%@page import="java.util.List"%>
<%@page import="com.kpmg.infraknowledge.portlet.InfraKnowledgePortlet"%>
<%@page import="com.kpmg.infraknowledge.constants.InfraKnowledgePortletKeys"%>
<%@page import="com.kpmg.citizenTables.service.InfraKnowledgeLocalServiceUtil"%>
<%@page import="com.kpmg.citizenTables.model.InfraKnowledge"%>
<%@page import="com.kpmg.citizenTables.model.InfraKnowledgeCategory"%>
<%@page import="com.kpmg.citizenTables.model.InfraKnowledgeSubCategory"%>
<%@page import="java.text.SimpleDateFormat"%>
<%@page import="com.liferay.portal.kernel.util.PortalUtil"%>
<portlet:resourceURL var="getMinistryOption1"></portlet:resourceURL>
<%
int pageSize = 9;
int currentPage = 1;

String currURL = "";
String type = "";
long tab = 0L;
try {
    currURL = PortalUtil.getCurrentURL(request);
    System.out.println("currURL=" + currURL);
    String[] strArray = null;
    strArray = currURL.split("\\?");
    if (strArray.length > 1) {
        String[] mainArray = null;
        mainArray = strArray[1].split("\\&");
        for (int i = 0; i < mainArray.length; i++) {
            String[] subArray = null;
            subArray = mainArray[i].split("\\=");
            if (subArray.length > 0) {
                System.out.println("subArray[0]=" + subArray[0]);
                if (subArray[0].equalsIgnoreCase("tab")) {
                    if (subArray[1] != "") {
                        System.out.println("subArray[1]=" + subArray[1]);
                        tab = Long.valueOf(subArray[1]);
                    }
                } else if (subArray[0].equalsIgnoreCase("type")) {
                    type = String.valueOf(subArray[1]);
                    System.out.println("Type:" + type);
                }
            }
        }
    }
} catch (Exception e) {
    e.printStackTrace();
}

if (type.equals("PAG"))
    type = "CENTRAL POLICIES";
if (type.equals("IFS"))
    type = "PPP DOCUMENT REPOSITORY";
System.out.println(type);

try {
    currentPage = ParamUtil.getInteger(request, "page", 1);
} catch (NumberFormatException e) {
    currentPage = 1;
}

int start = (currentPage - 1) * pageSize;

List<InfraKnowledge> infraKnowledgeList = null;
DynamicQuery dynamicQuery = InfraKnowledgeLocalServiceUtil.dynamicQuery();
dynamicQuery.add(RestrictionsFactoryUtil.eq("type", type));
dynamicQuery.add(RestrictionsFactoryUtil.eq("cateId", tab));
dynamicQuery.addOrder(OrderFactoryUtil.asc("createDate"));

try {
    infraKnowledgeList = InfraKnowledgeLocalServiceUtil.dynamicQuery(dynamicQuery, start, pageSize);
} catch (Exception e) {
    e.printStackTrace();
}

%>
<!-- HTML markup -->
<section class="page-title">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1>Infra-Knowledge: <%=type%></h1>
            </div>
        </div>
    </div>
</section>

<section class="ministry_details">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <% if (ListUtil.isNotEmpty(infraKnowledgeList)) {
                    for (InfraKnowledge infraKnowledge : infraKnowledgeList) { %>
                        <div class="row">
                            <!-- Resource cards loop -->
                            <div class="col-12">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title"><%= infraKnowledge.getTitle() %></h5>
                                        <p class="card-text"><%= infraKnowledge.getDescription() %></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }
                } else { %>
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info" role="alert">
                                No resources found.
                            </div>
                        </div>
                    </div>
                <% } %>

                <div class="row">
                    <ul class="pagination justify-content-center mt-2">
                        <% int totalItems = InfraKnowledgeLocalServiceUtil.dynamicQueryCount(dynamicQuery);
                        int totalPages = (int) Math.ceil(totalItems / (double) pageSize);
                        for (int i = 1; i <= totalPages; i++) { %>
                            <li class="page-item <%= currentPage == i ? "active" : "" %>">
                                <a class="page-link" href="<%= currURL + "?page=" + i %>"><%= i %></a>
                            </li>
                        <% } %>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>
